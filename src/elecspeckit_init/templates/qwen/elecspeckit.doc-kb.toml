description = "为知识库管理员生成设计经验和技术决策文档"

prompt = """---
description: 为知识库管理员生成设计经验和技术决策文档
handoffs: []
---

## Command: `/elecspeckit.doc-kb`

**Goal**
基于当前硬件特性的 `plan.md` 和 `tasks.md`，为知识库管理员生成设计经验和技术决策记录文档 `docs/kb-view.md`，捕获架构决策、Phase 0 研究结果、设计经验和关键技术选型理由，沉淀为可复用的知识资产。

**Execution Steps (for the AI assistant)**
1. 在目标项目根目录工作，与用户确认当前特性的 `FEATURE_DIR = specs/00X-shortname/`，并在其中定位：
   - `FEATURE_PLAN   = FEATURE_DIR/plan.md`；
   - `FEATURE_TASKS  = FEATURE_DIR/tasks.md`；
   - `FEATURE_RESEARCH = FEATURE_DIR/research.md`（如存在）；
   - `FEATURE_DOCS   = FEATURE_DIR/docs/`（如不存在，则创建）。

2. 从 `plan.md` 中提取架构决策记录（ADR）：
   - **Phase 0 研究问题**：提取研究问题列表（如"AHB vs LLC 拓扑选择"、"主控芯片选型"）；
   - **决策过程**：对于每个研究问题，提取：
     - **问题描述**：决策的背景和需要解决的问题；
     - **候选方案**：考虑的技术方案或器件选项（如"方案A: AHB拓扑"、"方案B: LLC拓扑"）；
     - **评估维度**：评估标准（如"效率"、"成本"、"设计复杂度"、"供货风险"）；
     - **决策结果**：最终选择的方案和理由；
     - **权衡说明**：放弃其他方案的原因（如"LLC效率更高但设计复杂度高，考虑团队经验选择AHB"）。

3. 从 `research.md`（如存在）提取研究结果：
   - **知识源引用**：提取引用的标准、参考设计、技术文档（如"参考: TI Application Note AN-2345"）；
   - **查询记录**：提取通过 `knowledge-sources.json` 执行的查询和结果（如"查询Metaso: PCB走线阻抗控制"）；
   - **实验数据**：提取原型验证或仿真结果（如"LTspice仿真显示效率94.3%"）；
   - **经验教训**：提取设计过程中的发现和教训（如"注意：输入滤波电容ESR对纹波影响显著"）。

4. 从 `tasks.md` 中提取 `[VIEW:KB]` 标记的任务：
   - 扫描 `tasks.md` 中所有任务描述；
   - 筛选包含 `[VIEW:KB]` 标记的任务；
   - 这些任务通常涉及设计经验总结、技术难点记录、可复用方案等。

5. 识别关键技术选型理由：
   - **主控芯片选型**：选择的芯片型号、供应商、关键参数、选择理由（如"选择TI TPS54360: 集成度高、参考设计丰富、供货稳定"）；
   - **拓扑选型**：选择的电源拓扑或架构模式，选择理由（如"选择Buck拓扑: 效率高、设计简单、成本低"）；
   - **关键器件选型**：MOSFET、二极管、电感、电容等关键器件的选型理由；
   - **PCB工艺选型**：层数、板厚、阻抗控制等PCB工艺参数选择理由。

6. 提取设计经验和最佳实践：
   - **设计规则**：从设计过程中总结的规则（如"输出端滤波电容ESR应<10mΩ"、"Flyback反馈回路补偿需考虑RHP零点"）；
   - **常见陷阱**：设计中遇到的问题和解决方案（如"问题: 输出纹波过大；原因: 输出滤波电容ESR过高；解决: 更换低ESR电容"）；
   - **调试技巧**：调试和验证的经验（如"调试建议: 先轻载测试，再逐步加载至满载，观察热点分布"）；
   - **可复用方案**：可迁移到其他项目的设计方案（如"输入保护电路方案（含TVS、保险丝、滤波电容）可复用"）。

7. 识别知识缺口和待研究问题：
   - 标记为"待研究"或"待验证"的技术问题；
   - 遗留的技术债务（如"TODO: 优化环路补偿参数"）；
   - 未来改进方向（如"下一版本: 考虑采用同步整流提升效率"）。

8. 生成 `FEATURE_DIR/docs/kb-view.md`：
   - **项目概览**：特性名称、技术领域、设计目标；
   - **架构决策记录（ADR）**：列出所有关键架构决策、候选方案、评估过程、最终决策和理由；
   - **技术选型总结**：主控芯片、拓扑、关键器件、PCB工艺等选型理由；
   - **研究结果摘要**：Phase 0 研究问题、查询记录、知识源引用、实验数据；
   - **设计经验和最佳实践**：设计规则、常见陷阱、调试技巧、可复用方案；
   - **知识缺口和待研究问题**：遗留问题、技术债务、未来改进方向；
   - **知识资产清单**：列出可复用的设计方案、参考文档、测试数据等。

9. 向用户总结：
   - 本次生成的 `kb-view.md` 包含了哪些架构决策和设计经验；
   - 识别的可复用知识资产（如"输入保护电路方案"、"环路补偿参数计算方法"）；
   - 提醒补充的内容（如"Phase 0研究结果待完善"、"调试经验待总结"）；
   - 建议下一步操作（如"请知识库管理员审阅并归档到公司知识库"、"可复用方案建议整理为模板"）。

**Important Notes**
- 本命令生成的是**内部知识沉淀文档**，不对外发布，目的是积累设计经验和可复用方案；
- 架构决策记录（ADR）应包含决策的背景、候选方案、权衡过程，而非仅记录最终结果；
- 设计经验应具体、可操作，避免空泛描述（如"某些情况下需要注意"）；
- 可复用方案应明确适用场景和使用条件，便于其他项目参考。

**Example Output Structure**

```markdown
# 知识库视图: [特性名称]

## 项目概览
- **特性名称**: 100W 开关电源模块
- **技术领域**: 电源管理、AC-DC转换
- **设计目标**: 高效率、低成本、紧凑尺寸
- **完成日期**: 2025-01-15

## 架构决策记录（ADR）

### ADR-001: 电源拓扑选择
**问题**: 选择 100W AC-DC 开关电源的拓扑方案

**候选方案**:
- **方案A: Flyback 拓扑**
  - 优点: 设计简单、成本低、器件数少
  - 缺点: 100W功率下变压器体积较大、效率受限（~85%）
- **方案B: AHB（非对称半桥）拓扑**
  - 优点: 效率高（~92%）、变压器体积小、EMI性能好
  - 缺点: 设计复杂度高、需要两个开关管
- **方案C: LLC 谐振拓扑**
  - 优点: 效率最高（~95%）、EMI最优
  - 缺点: 设计复杂度最高、调试难度大、团队缺乏经验

**评估维度**:
| 方案 | 效率 | 成本 | 设计复杂度 | 团队经验 | 综合评分 |
|------|------|------|------------|----------|----------|
| Flyback | ★★★☆☆ | ★★★★★ | ★★★★★ | ★★★★★ | 16/20 |
| AHB | ★★★★☆ | ★★★★☆ | ★★★☆☆ | ★★★★☆ | 17/20 |
| LLC | ★★★★★ | ★★★☆☆ | ★★☆☆☆ | ★★☆☆☆ | 15/20 |

**决策结果**: 选择 **AHB 拓扑**

**决策理由**:
1. 效率（92%）满足目标（>90%），显著优于Flyback；
2. 设计复杂度适中，团队有半桥拓扑经验；
3. 成本可接受，比LLC简单，调试风险低；
4. 参考设计丰富（TI、Infineon均有参考设计）。

**权衡说明**: 虽然LLC效率最高，但考虑团队经验和项目周期（2个月），AHB是最佳平衡点。

---

### ADR-002: 主控芯片选型
**问题**: 选择 AHB 拓扑的主控芯片

**候选方案**:
- **TI UCC28950**: 专用AHB控制器，集成度高，参考设计丰富
- **Infineon ICE2HS01G**: 成本低，功能相对简单
- **NXP TEA1795T**: 集成PFC+AHB，高集成度

**决策结果**: 选择 **TI UCC28950**

**决策理由**:
1. 参考设计最丰富（TI官网有完整100W设计案例）；
2. 技术支持响应快（工程师反馈24小时内回复）；
3. 供货稳定（供应商确认库存充足，交期2周）；
4. 团队之前使用过TI芯片，学习成本低。

---

## 技术选型总结

### 主控芯片
- **型号**: TI UCC28950
- **关键参数**:
  - 工作频率: 100kHz
  - 输入电压范围: 85-265VAC（通过PFC级）
  - 保护功能: OVP、UVP、OCP、OTP
- **选择理由**: 参考设计丰富、供货稳定、技术支持好

### 关键器件选型
| 器件类型 | 型号 | 关键参数 | 选择理由 |
|---------|------|---------|---------|
| 高边MOSFET | Infineon IPP60R099C6 | 600V/58A, Rds(on)=99mΩ | 导通损耗低、雪崩能量高 |
| 低边MOSFET | Infineon IPP65R110CFD | 650V/36A, Rds(on)=110mΩ | 快速恢复、寄生电容小 |
| 输出整流二极管 | ON Semi MBR40250 | 40A/250V, Schottky | 正向压降低(0.85V)、恢复快 |
| 输出滤波电容 | Rubycon 100μF/25V | ESR<10mΩ, 105°C | 低ESR、长寿命、耐高温 |
| 变压器磁芯 | TDK PC40 EE42 | AL≈2500nH, Ae=181mm² | 功率密度高、损耗低 |

### PCB工艺选型
- **层数**: 4层板（Top信号层、GND层、Power层、Bottom信号层）
- **板厚**: 1.6mm
- **铜厚**: 2oz（输出大电流路径）
- **阻抗控制**: 无（高速信号少，不需要）
- **选择理由**: 4层板散热性能好、成本可接受、2oz铜厚满足大电流要求

---

## 研究结果摘要

### Phase 0 研究问题

#### Q1: AHB拓扑变压器设计方法
- **知识源**: TI Application Note SLUA592, Metaso查询"半桥变压器设计"
- **关键发现**:
  - 变压器匝比 N = Vin_min / (2×Vout) ≈ 7:1（考虑85VAC最低输入）
  - 磁芯面积积 Ae×Aw ≥ 0.4 cm⁴（100W功率、100kHz频率）
  - 绕组结构: 采用"三明治"绕法（原边-次边-原边）降低漏感
- **参考文档**: TI SLUA592, Infineon AN2012-03

#### Q2: 输出纹波抑制方法
- **知识源**: 公司知识库、Volces 查询"开关电源纹波抑制"
- **关键发现**:
  - 输出滤波电容ESR是纹波主要来源（纹波≈ΔI×ESR）
  - 选择低ESR电容（<10mΩ）可将纹波降至<100mVpp
  - 并联多个小电容比单个大电容效果好（降低ESR和ESL）
- **实验数据**: 使用3个33μF/25V并联（总ESR=3mΩ），纹波实测50mVpp

---

## 设计经验和最佳实践

### 设计规则
1. **输出滤波电容选择**:
   - 电容量: C_out ≥ 2×I_out / (f×ΔV_ripple)，100W/12V → 100μF以上
   - ESR限制: ESR < 10mΩ（目标纹波<100mVpp）
   - 耐压: 至少1.5倍额定电压（12V输出→选25V电容）
   - 推荐: Rubycon MCZ系列或Nichicon PW系列

2. **变压器绕组设计**:
   - 绕组结构: 采用"三明治"绕法（Sec-Pri-Sec）降低漏感
   - 线径选择: 根据电流密度5A/mm²选择（避免趋肤效应用多股绞线）
   - 层间绝缘: 原次边间加3层聚酯膜（满足加强绝缘要求）

3. **PCB布局关键点**:
   - 高频电流回路面积最小化（MOSFET-变压器-整流二极管-输出电容）
   - 大电流路径铜皮加宽、铜厚加厚（输出12V/8A路径→宽度≥5mm）
   - GND层完整、不分割（避免产生寄生电感）

### 常见陷阱和解决方案

#### 陷阱1: 输出纹波过大
- **现象**: 输出纹波测量>200mVpp，超过规格要求（<100mVpp）
- **原因**: 输出滤波电容ESR过高（实测22mΩ）
- **解决方案**: 更换为低ESR电容（Rubycon MCZ 100μF/25V, ESR=3mΩ），纹波降至50mVpp
- **经验教训**: 选型时不仅看电容量，ESR是关键参数

#### 陷阱2: MOSFET发热严重
- **现象**: 高边MOSFET温升>80°C（环境温度25°C）
- **原因**:
  1. 导通损耗过高（Rds(on)选型偏大）
  2. 散热器尺寸不足
- **解决方案**:
  1. 更换为更低Rds(on)的MOSFET（99mΩ→60mΩ）
  2. 加大散热器（20cm²→40cm²）
  3. 温升降至55°C
- **经验教训**: 热设计需要在选型阶段考虑，不能事后补救

#### 陷阱3: EMC测试不通过（传导发射超标）
- **现象**: 150kHz-1MHz频段超标5dB
- **原因**: 输入端共模滤波不足
- **解决方案**:
  1. 输入端增加共模电感（2×2.2mH）
  2. X电容增大（0.1μF→0.47μF）
  3. 重新测试通过
- **经验教训**: 输入滤波电路设计裕量要足够，建议参考同类产品经典方案

### 调试技巧
1. **首次上电顺序**:
   - 使用电子负载模拟负载，设置为恒流模式10%额定电流
   - 输入端串联电流表，监控输入电流（异常会立即显示）
   - 逐步增加负载至100%，观察输出电压稳定性和温升

2. **纹波测量**:
   - 使用示波器带宽限制（20MHz），避免高频噪声干扰
   - 探头接地线尽量短（<1cm），避免引入寄生电感
   - 测量点在输出端子处，而非电容引脚（真实反映输出纹波）

3. **效率测试**:
   - 使用功率分析仪（而非万用表），测量真实功率
   - 测量多个负载点（10%, 25%, 50%, 75%, 100%）
   - 记录温升，确认热设计裕量

### 可复用方案

#### 方案1: 输入保护电路
- **适用场景**: 85-265VAC通用输入的AC-DC电源
- **电路方案**:
  - 保险丝: 2A慢断（T2AL250V）
  - TVS管: P6KE250CA（双向250V TVS）
  - 压敏电阻: 14D471K（470V压敏电阻）
  - X电容: 0.47μF/275VAC（抑制差模干扰）
  - Y电容: 2×2.2nF/250VAC（抑制共模干扰）
- **使用条件**: 输入功率<150W，满足IEC 61000-4-5 Level 3
- **参考文档**: `circuits/input-protection.pdf`

#### 方案2: 输出过压保护（OVP）
- **适用场景**: 12V输出电源，需要保护后级负载
- **电路方案**:
  - 监控芯片: TL431（可调参考）
  - 保护阈值: 13.5V（+12.5% overvoltage）
  - 动作逻辑: 触发SCR关断主开关，锁定故障
- **使用条件**: 12V输出、负载敏感（如MCU、FPGA）
- **参考文档**: `circuits/ovp-protection.pdf`

---

## 知识缺口和待研究问题

### 待验证问题
1. **同步整流方案**: 当前使用肖特基二极管，效率受限（损耗~5W），下一版本可考虑同步整流MOSFET，预期效率提升2%，需研究控制方案和成本
2. **宽范围调光**: 当前仅支持满载输出，如需支持10%-100%调光，需研究PWM调光或模拟调光方案

### 技术债务
1. **环路补偿优化**: 当前使用典型值，未针对本设计优化，动态响应可能不是最优（待用网络分析仪测试波特图）
2. **热仿真验证**: 热设计基于经验公式，未进行CFD仿真，可能存在热点（待热成像仪验证）

### 未来改进方向
1. **数字控制**: 考虑使用数字电源控制器（如TI C2000），实现更精确的控制和遥测功能
2. **模块化设计**: 将输入级、转换级、输出级模块化，便于功率等级扩展（如50W、100W、150W共用模块）

---

## 知识资产清单

### 可复用设计方案
| 方案名称 | 文档路径 | 适用场景 | 复用难度 |
|---------|---------|---------|---------|
| 输入保护电路 | `circuits/input-protection.pdf` | 85-265VAC输入的AC-DC电源 | 低（直接复用） |
| 输出过压保护 | `circuits/ovp-protection.pdf` | 12V输出电源 | 低（调整阈值即可） |
| AHB变压器设计 | `docs/transformer-design.xlsx` | 100W±30% AHB拓扑 | 中（需重新计算匝比） |
| EMC输入滤波 | `circuits/emc-filter.pdf` | 传导发射需要通过Class B | 低（直接复用） |

### 参考文档
1. TI SLUA592: "Transformer Design for Isolated Switching Power Supplies"
2. Infineon AN2012-03: "CCM PFC Design Guide"
3. 公司内部: "开关电源PCB布局指南 v2.3"

### 测试数据
1. 效率曲线数据: `test-data/efficiency-curve.csv`
2. 热成像照片: `test-data/thermal-images/`
3. EMC测试报告: `test-data/emc-report-20250115.pdf`

---

**知识库维护建议**:
1. 本文档应归档到公司知识库"电源管理"类别；
2. 可复用方案建议整理为标准电路库模板；
3. 架构决策记录（ADR）可作为培训材料，供新员工学习；
4. 设计经验和陷阱应定期更新，避免团队重复踩坑。
```

"""